// Copyright Epic Games, Inc. All Rights Reserved.
#if WITH_TESTS

#include "Cloud/MetaHumanZlib.h"
#include "Misc/AutomationTest.h"

IMPLEMENT_SIMPLE_AUTOMATION_TEST(FMetaHumanZlibCompressionTest, "MetaHuman.ZlibCompressionTest", EAutomationTestFlags::EditorContext | EAutomationTestFlags::EngineFilter)

bool FMetaHumanZlibCompressionTest::RunTest(const FString& Parameters)
{
	const char* JsonDataToCompress=
		"{\
		\"head\":\
		{\
			\"\face\": [\
				[ 9.2541446685791016, 1.9964790344238281, -2.1923840045928955 ],\
					[9.1102170944213867, 2.1644020080566406, -2.3764770030975342],\
					[8.9397716522216797, 2.342426061630249, -2.5278348922729492],\
					[9.1625375747680664, 2.3172640800476074, -2.2975161075592041],\
					[8.9834995269775391, 2.4666171073913574, -2.4412910938262939],\
					[9.3198080062866211, 2.166187047958374, -2.1268579959869385],\
					[8.7576980590820312, 2.5112650394439697, -2.6531839370727539],\
					[8.7955160140991211, 2.6091649532318115, -2.5646059513092041],\
					[9.3841457366943359, 1.8227880001068115, -1.9686880111694336],\
					[9.6100063323974609, 1.5144540071487427, -1.4623939990997314],\
					[9.701970100402832, 1.6873819828033447, -1.4466660022735596],\
					[9.6032018661499023, 1.8281899690628052, -1.6921249628067017],\
					[9.5139579772949219, 1.6574289798736572, -1.7185369729995728],\
					[9.4693927764892578, 1.9982949495315552, -1.9247269630432129],\
					[9.5411109924316406, 4.0210738182067871, -1.3200880289077759],\
					[9.6731691360473633, 4.1064767837524414, -0.98511898517608643],\
					[9.5171804428100586, 4.2438530921936035, -0.99014300107955933],\
					[9.4018573760986328, 4.164431095123291, -1.3275140523910522],\
					[9.0719575881958008, 3.7409989833831787, -1.9513759613037109],\
					[9.2276144027709961, 3.8357560634613037, -1.790302038192749],\
					[9.1275453567504883, 3.9843618869781494, -1.8155839443206787],\
					[8.987213134765625, 3.8887650966644287, -1.9870510101318359],\
					[8.8556022644042969, 3.7843959331512451, -2.1348030567169189],\
					[8.7126884460449219, 3.6704740524291992, -2.2722399234771729],\
					[8.4407415390014648, 3.3106410503387451, -2.4514200687408447],\
					[8.4088754653930664, 3.3823270797729492, -2.527695894241333],\
					[8.2930727005004883, 3.235598087310791, -2.6342699527740479],\
					[8.3144435882568359, 3.1812009811401367, -2.5495591163635254],\
					[8.5974769592285156, 3.4336121082305908, -2.3367249965667725],\
					[8.5547676086425781, 3.531466007232666, -2.4058890342712402],\
					[8.9258384704589844, 3.6447319984436035, -2.0883960723876953],\
					[8.7681713104248047, 3.5472290515899658, -2.2128820419311523],\
					[9.6042213439941406, 4.2982039451599121, -0.57688099145889282],\
					[9.6304845809936523, 4.3093280792236328, -0.13321800529956818],\
					[9.7760190963745117, 4.1691608428955078, -0.58343601226806641],\
					[9.823948860168457, 4.2026991844177246, -0.14041599631309509],\
					[8.2292118072509766, 3.0925629138946533, -2.7189369201660156],\
					[8.2228488922119141, 2.9847440719604492, -2.7684879302978516],\
					[8.3068752288818359, 2.885059118270874, -2.7905890941619873],\
					[8.2701005935668945, 2.9115939140319824, -2.6752219200134277],\
					[8.1921195983886719, 2.9776949882507324, -2.6569368839263916],\
					[8.4349822998046875, 2.7768430709838867, -2.7881889343261719],\
					[8.5815706253051758, 2.6580080986022949, -2.7413389682769775],\
					[8.6041364669799805, 2.7316620349884033, -2.6422660350799561],\
					[8.4281234741210938, 2.8309509754180908, -2.6781370639801025],\
					[8.227259635925293, 3.0526149272918701, -2.6211709976196289],\
					[9.7110137939453125, 1.4001200199127197, -1.2114379405975342],\
					[9.7893953323364258, 1.5670360326766968, -1.2028789520263672],\
					[9.8030099868774414, 1.3094680309295654, -0.93015801906585693],\
					[9.8977508544921875, 1.4813729524612427, -0.9259909987449646],\
					[9.3856601715087891, 3.9306659698486328, -1.5828969478607178],\
					[9.2689380645751953, 4.0767688751220703, -1.5977760553359985],\
					[9.9052915573120117, 1.3465160131454468, -0.49364599585533142],\
					[10.025935173034668, 1.5351760387420654, -0.46288800239562988],\
					[7.7777361869812012, 4.1640338897705078, -1.5907829999923706],\
					[7.8714132308959961, 3.7169370651245117, -1.5618749856948853],\
					[7.7462611198425293, 3.6952080726623535, -1.6464929580688477],\
					[7.64385986328125, 4.135591983795166, -1.6912020444869995],\
					[8.2401800155639648, 4.2449522018432617, -1.0495719909667969],\
					[8.3285112380981445, 3.7822139263153076, -1.0605800151824951],\
					[8.220916748046875, 3.7671680450439453, -1.2094830274581909],\
					[8.1416759490966797, 4.2227802276611328, -1.225180983543396],\
					[8.4880180358886719, 4.277040958404541, -0.32135599851608276],\
					[8.611170768737793, 3.7983109951019287, -0.31502801179885864],\
					[8.5657863616943359, 3.794680118560791, -0.51084798574447632],\
					[8.4497365951538086, 4.2748432159423828, -0.50934302806854248],\
					[7.1795320510864258, 3.9619779586791992, -2.0216009616851807],\
					[7.3475198745727539, 3.6387360095977783, -1.9308270215988159],\
					[7.2324938774108887, 3.6039299964904785, -2.0062398910522461],\
					[7.0611729621887207, 3.867311954498291, -2.0937850475311279],\
					[2.0133368968963623, 3.5377840995788574, -2.3185420036315918],\
					[2.7141640186309814, 5.154879093170166, -2.0358209609985352],\
					[6.4593372344970703, 4.5787220001220703, -2.3278820514678955],\
					[6.8142890930175781, 4.0902280807495117, -2.1982779502868652],\
					[6.5822200775146484, 3.7816340923309326, -2.330496072769165],\
					[6.0256271362304688, 3.9839959144592285, -2.5056788921356201],\
					[7.0633292198181152, 4.326693058013916, -2.0824129581451416],\
					[6.947688102722168, 3.7747828960418701, -2.152379035949707],\
					[6.8531851768493652, 3.6457240581512451, -2.2154290676116943],\
					[8.3531560897827148, 4.5832839012145996, -0.62883299589157104],\
					[8.443272590637207, 4.5804619789123535, -0.24249699711799622],\
					[4.9039039611816406, 5.184053897857666, -1.5321290493011475],\
					[4.6104860305786133, 4.9360837936401367, -2.6134140491485596],\
					[4.0906472206115723, 3.4216649532318115, -2.9246890544891357],\
					[6.9931368827819824, 4.7343010902404785, -1.5221580266952515],\
					[7.2734508514404297, 4.7828850746154785, -0.71267002820968628],\
					[9.1802377700805664, 2.482227087020874, -2.1994979381561279],\
					[8.9940013885498047, 2.6032140254974365, -2.3365271091461182],\
					[9.3501987457275391, 2.3540070056915283, -2.0335099697113037],\
					[9.771204948425293, 1.9369850158691406, -1.3709679841995239],\
					[9.6528692245483398, 2.064655065536499, -1.6080880165100098],\
					[9.5118007659912109, 2.215533971786499, -1.8335080146789551],\
					[9.6735057830810547, 3.7455921173095703, -1.2897839546203613],\
					[9.8231592178344727, 3.8228631019592285, -0.95989400148391724],\
					[9.1305418014526367, 3.5334489345550537, -1.8939510583877563],\
					[9.3059425354003906, 3.6021449565887451, -1.7341749668121338],\
					[9.9088411331176758, 3.8837449550628662, -0.56735199689865112],\
					[9.9517335891723633, 3.9137589931488037, -0.1596820056438446],\
					[8.1273565292358398, 2.9977450370788574, -2.5417599678039551],\
					[8.1825752258300781, 3.0373411178588867, -2.506274938583374],\
					[8.3175649642944336, 3.1225309371948242, -2.44923996925354],\
					[8.456364631652832, 3.2204160690307617, -2.3553800582885742],\
					[8.6191701889038086, 3.3125491142272949, -2.253715991973877],\
					[8.9607028961181641, 3.463655948638916, -2.022852897644043],\
					[8.8015003204345703, 3.3946409225463867, -2.1423881053924561],\
					[8.3969268798828125, 2.8960599899291992, -2.5540709495544434],\
					[8.1828994750976562, 2.9657320976257324, -2.5373470783233643],\
					[8.6000118255615234, 2.8195369243621826, -2.5227069854736328],\
					[8.7980566024780273, 2.7154579162597656, -2.4481420516967773],\
					[9.9732456207275391, 1.7883189916610718, -0.81848698854446411],\
					[10.091152191162109, 1.8116339445114136, -0.40242499113082886],\
					[8.0181589126586914, 3.0263400077819824, -2.3868439197540283],\
					[8.0018863677978516, 3.0249819755554199, -2.4077990055084229]\
				}\
		}";

	TArray<uint8> Data;
	Data.Append(reinterpret_cast<const uint8*>(JsonDataToCompress), strlen(JsonDataToCompress));
	int32 Len = Data.Num();
	TArray<uint8> Deflated;
	UE::MetaHuman::FZlib::Deflate(Deflated, Data, UE::MetaHuman::FZlib::Format::WithZlibHeader);
	TArray<uint8> Inflated;
	UE::MetaHuman::FZlib::Inflate(Inflated, Deflated, UE::MetaHuman::FZlib::Format::WithZlibHeader);

	bool Result = Deflated.Num() < Inflated.Num() && Inflated == Data;
	if (Result)
	{
		Deflated.Empty();
		Inflated.Empty();
		UE::MetaHuman::FZlib::Deflate(Deflated, Data, UE::MetaHuman::FZlib::Format::Raw);
		UE::MetaHuman::FZlib::Inflate(Inflated, Deflated, UE::MetaHuman::FZlib::Format::Raw);
		Result = Deflated.Num() < Inflated.Num() && Inflated == Data;
	}

	return Result;
}

#endif // #if WITH_TESTS